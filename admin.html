<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | Mike Ross & Attorneys</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #6b7280; /* bg-gray-500 */
            }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Auth guard: This section will be hidden if user is logged in with correct role -->
    <div id="auth-blocker-admin" class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center">
        <h1 class="text-3xl font-bold text-white mb-4">Access Denied</h1>
        <p class="text-gray-400 mb-8">You must have an administrative role to view this page.</p>
        <div id="loading-spinner-admin" class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400"></div>
        <a href="index.html" id="redirect-link-admin" class="hidden mt-8 text-yellow-400 hover:text-yellow-300">Click here to log in</a>
    </div>

    <!-- Admin Portal Content -->
    <div id="admin-portal-content" class="hidden min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 p-6 flex-shrink-0 flex flex-col">
            <div class="flex items-center mb-10">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mr-3 text-red-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" />
                </svg>
                <h2 class="text-xl font-bold text-white">Admin Suite</h2>
            </div>
            <nav id="admin-nav" class="flex flex-col space-y-2">
                <a href="#analytics" class="admin-nav-link bg-gray-700 text-white flex items-center px-4 py-3 rounded-lg">Firm Analytics</a>
                <a href="#staff" class="admin-nav-link text-gray-400 hover:bg-gray-700 hover:text-white flex items-center px-4 py-3 rounded-lg">Staff Management</a>
                <a href="#oversight" class="admin-nav-link text-gray-400 hover:bg-gray-700 hover:text-white flex items-center px-4 py-3 rounded-lg">Financial Oversight</a>
            </nav>
            <a href="portal.html" class="mt-auto text-yellow-400 hover:text-yellow-300">&larr; Back to Main Portal</a>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">

            <!-- Firm Analytics Page -->
            <div id="analytics" class="admin-page-content">
                <h1 class="text-3xl font-bold text-white mb-6">Firm Analytics</h1>

                <!-- Financial Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-400 mb-2">Total Revenue (All Time)</h3>
                        <p id="total-revenue" class="text-4xl font-bold text-green-400">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-400 mb-2">Active Cases</h3>
                        <p id="active-cases" class="text-4xl font-bold text-blue-400">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-400 mb-2">Total Staff</h3>
                        <p id="total-staff" class="text-4xl font-bold text-white">0</p>
                    </div>
                </div>

                <!-- Attorney Performance Table -->
                <div>
                    <h2 class="text-2xl font-semibold text-white mb-4">Attorney Performance</h2>
                    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50">
                                <tr>
                                    <th class="p-4 font-semibold">Attorney</th>
                                    <th class="p-4 font-semibold">Active Cases</th>
                                    <th class="p-4 font-semibold">Total Cases Handled</th>
                                </tr>
                            </thead>
                            <tbody id="attorney-performance-body">
                                <!-- Attorney data will be dynamically populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Staff Management Page -->
            <div id="staff" class="admin-page-content hidden">
                <h1 class="text-3xl font-bold text-white mb-6">Staff Management</h1>
                <div class="bg-gray-800 rounded-lg border border-gray-700">
                    <table class="w-full text-left">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="p-4 font-semibold">Name</th>
                                <th class="p-4 font-semibold">Email</th>
                                <th class="p-4 font-semibold">Role</th>
                                <th class="p-4 font-semibold text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staff-table-body">
                            <!-- Staff data will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-8">
                    <h2 class="text-2xl font-semibold text-white mb-4">Invite New Staff</h2>
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                        <p class="text-gray-400 mb-4">To add a new staff member, you must first create an account for them in the Firebase Authentication console. Once they log in for the first time, their account will appear here automatically. You can then assign them a name and a role.</p>
                        <a href="https://console.firebase.google.com/project/mike-ross-attorneys/authentication/users" target="_blank" class="inline-block bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-yellow-300">Go to Firebase Auth</a>
                    </div>
                </div>
            </div>

            <!-- Financial Oversight Page -->
            <div id="oversight" class="admin-page-content hidden">
                <h1 class="text-3xl font-bold text-white mb-6">Financial Oversight</h1>

                <!-- Expense Approval Section -->
                <div class="mb-12">
                    <h2 class="text-2xl font-semibold text-white mb-4">Expense Approval Queue</h2>
                    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50">
                                <tr>
                                    <th class="p-4 font-semibold">Date</th>
                                    <th class="p-4 font-semibold">Submitted By</th>
                                    <th class="p-4 font-semibold">Description</th>
                                    <th class="p-4 font-semibold text-right">Amount</th>
                                    <th class="p-4 font-semibold text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expense-approval-body">
                                <!-- Expenses needing approval will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payroll Section -->
                <div>
                    <h2 class="text-2xl font-semibold text-white mb-4">Log Payroll Distribution</h2>
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                        <form id="payroll-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div>
                                <label for="payroll-staff-select" class="block text-sm font-medium text-gray-400 mb-1">Staff Member</label>
                                <select id="payroll-staff-select" required class="w-full bg-gray-700 border border-gray-600 rounded p-2.5"></select>
                            </div>
                            <div>
                                <label for="payroll-amount" class="block text-sm font-medium text-gray-400 mb-1">Amount ($)</label>
                                <input type="number" id="payroll-amount" required class="w-full bg-gray-700 border border-gray-600 rounded p-2.5" placeholder="5000.00">
                            </div>
                            <button type="submit" class="bg-green-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-green-500 h-fit">Log Payroll</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, setDoc, addDoc, onSnapshot, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDDzac6Aex6lLCzpz0yedIIYcUX0wuTZwU",
            authDomain: "mike-ross-attorneys.firebaseapp.com",
            projectId: "mike-ross-attorneys",
            storageBucket: "mike-ross-attorneys.appspot.com",
            messagingSenderId: "812906116208",
            appId: "1:812906116208:web:71e217e944a6f937d9435b"
        };

        const EXPENSE_APPROVAL_THRESHOLD = 50000;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authBlocker = document.getElementById('auth-blocker-admin');
        const adminPortalContent = document.getElementById('admin-portal-content');
        const loadingSpinner = document.getElementById('loading-spinner-admin');
        const redirectLink = document.getElementById('redirect-link-admin');
        const staffTableBody = document.getElementById('staff-table-body');

        // Analytics Elements
        const totalRevenueEl = document.getElementById('total-revenue');
        const activeCasesEl = document.getElementById('active-cases');
        const totalStaffEl = document.getElementById('total-staff');
        const attorneyPerformanceBody = document.getElementById('attorney-performance-body');

        // Financial Oversight Elements
        const expenseApprovalBody = document.getElementById('expense-approval-body');
        const payrollForm = document.getElementById('payroll-form');
        const payrollStaffSelect = document.getElementById('payroll-staff-select');
        const payrollAmountInput = document.getElementById('payroll-amount');


        let allUsers = []; // To store combined auth and Firestore data

        function renderStaffTable() {
            staffTableBody.innerHTML = '';
            payrollStaffSelect.innerHTML = '<option value="">Select Staff...</option>';

            if (allUsers.length === 0) {
                staffTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-gray-500">No user profiles found in Firestore. Create users in Auth, then set their roles here.</td></tr>`;
                return;
            }
            totalStaffEl.textContent = allUsers.length;

            allUsers.forEach(user => {
                // Add to payroll dropdown
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name;
                payrollStaffSelect.appendChild(option);

                // Add to staff management table
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `
                        <td class="p-4">
                            <input type="text" value="${user.name || ''}" data-uid="${user.uid}" class="name-input w-full bg-gray-700 border border-gray-600 rounded p-2" placeholder="Enter Name">
                        </td>
                        <td class="p-4 text-gray-400">${user.email || 'Email not found'}</td>
                        <td class="p-4">
                            <select data-uid="${user.uid}" class="role-select w-full bg-gray-700 border border-gray-600 rounded p-2">
                                <option value="Staff" ${user.role === 'Staff' ? 'selected' : ''}>Staff</option>
                                <option value="Attorney" ${user.role === 'Attorney' ? 'selected' : ''}>Attorney</option>
                                <option value="Paralegal" ${user.role === 'Paralegal' ? 'selected' : ''}>Paralegal</option>
                                <option value="Partner" ${user.role === 'Partner' ? 'selected' : ''}>Partner</option>
                                <option value="Senior Partner" ${user.role === 'Senior Partner' ? 'selected' : ''}>Senior Partner</option>
                                <option value="Managing Partner" ${user.role === 'Managing Partner' ? 'selected' : ''}>Managing Partner</option>
                            </select>
                        </td>
                        <td class="p-4 text-center">
                            <button data-uid="${user.uid}" class="save-btn bg-yellow-500 text-white font-bold py-2 px-4 rounded hover:bg-yellow-400">Save</button>
                        </td>
                    `;
                staffTableBody.appendChild(row);
            });
        }

        staffTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('save-btn')) {
                const uid = e.target.dataset.uid;
                const nameInput = document.querySelector(`.name-input[data-uid="${uid}"]`);
                const roleSelect = document.querySelector(`.role-select[data-uid="${uid}"]`);

                const updatedData = {
                    name: nameInput.value,
                    role: roleSelect.value,
                    email: allUsers.find(u => u.uid === uid).email // ensure email is preserved
                };

                try {
                    const userRef = doc(db, 'users', uid);
                    // Using setDoc with merge to create or update the document
                    await setDoc(userRef, updatedData, { merge: true });
                    e.target.textContent = 'Saved!';
                    e.target.classList.remove('bg-yellow-500');
                    e.target.classList.add('bg-green-500');
                    setTimeout(() => {
                        e.target.textContent = 'Save';
                        e.target.classList.remove('bg-green-500');
                        e.target.classList.add('bg-yellow-500');
                    }, 2000);
                } catch (error) {
                    console.error("Error updating user:", error);
                    alert("Failed to update user profile.");
                }
            }
        });

        // --- Analytics Functions ---
        function listenForAnalytics() {
            // Total Revenue
            const transactionsQuery = query(collection(db, "transactions"), where("type", "in", ["Retainer", "Payment"]));
            onSnapshot(transactionsQuery, (snapshot) => {
                let total = 0;
                snapshot.forEach(doc => { total += doc.data().amount; });
                totalRevenueEl.textContent = `$${total.toFixed(2)}`;
            });

            // Active Cases
            const casesQuery = query(collection(db, "cases"), where("status", "==", "Active"));
            onSnapshot(casesQuery, (snapshot) => {
                activeCasesEl.textContent = snapshot.size;
            });

            // Attorney Performance
            onSnapshot(collection(db, "cases"), (casesSnapshot) => {
                const attorneyStats = {};
                allUsers.forEach(user => {
                    if (user.role === 'Attorney' || user.role === 'Partner' || user.role === 'Senior Partner' || user.role === 'Managing Partner') {
                        attorneyStats[user.name] = { active: 0, total: 0 };
                    }
                });

                casesSnapshot.forEach(doc => {
                    const caseData = doc.data();
                    if (attorneyStats[caseData.assignedTo]) {
                        attorneyStats[caseData.assignedTo].total++;
                        if (caseData.status === 'Active') {
                            attorneyStats[caseData.assignedTo].active++;
                        }
                    }
                });

                attorneyPerformanceBody.innerHTML = '';
                for (const attorney in attorneyStats) {
                    const row = `
                            <tr class="border-b border-gray-700">
                                <td class="p-4">${attorney}</td>
                                <td class="p-4">${attorneyStats[attorney].active}</td>
                                <td class="p-4">${attorneyStats[attorney].total}</td>
                            </tr>
                         `;
                    attorneyPerformanceBody.innerHTML += row;
                }
            });
        }

        // --- Financial Oversight Functions ---
        function listenForExpenseApprovals() {
            const expensesQuery = query(collection(db, "transactions"),
                where("type", "==", "Expense"),
                where("amount", ">=", EXPENSE_APPROVAL_THRESHOLD),
                where("status", "==", "Pending Approval")
            );

            onSnapshot(expensesQuery, (snapshot) => {
                expenseApprovalBody.innerHTML = '';
                if (snapshot.empty) {
                    expenseApprovalBody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-gray-500">No expenses are currently pending approval.</td></tr>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const expense = doc.data();
                    const row = `
                            <tr class="border-b border-gray-700">
                                <td class="p-4">${new Date(expense.createdAt).toLocaleDateString()}</td>
                                <td class="p-4">${expense.loggedBy}</td>
                                <td class="p-4">${expense.description}</td>
                                <td class="p-4 text-right text-red-400 font-mono">-$${expense.amount.toFixed(2)}</td>
                                <td class="p-4 text-center space-x-2">
                                    <button data-id="${doc.id}" class="approve-btn bg-green-600 text-white font-bold py-1 px-3 rounded text-sm hover:bg-green-500">Approve</button>
                                    <button data-id="${doc.id}" class="deny-btn bg-red-600 text-white font-bold py-1 px-3 rounded text-sm hover:bg-red-500">Deny</button>
                                </td>
                            </tr>
                        `;
                    expenseApprovalBody.innerHTML += row;
                });
            });
        }

        expenseApprovalBody.addEventListener('click', async (e) => {
            const target = e.target;
            const transactionId = target.dataset.id;
            if (!transactionId) return;

            let newStatus = '';
            if (target.classList.contains('approve-btn')) newStatus = 'Approved';
            if (target.classList.contains('deny-btn')) newStatus = 'Denied';

            if (newStatus) {
                try {
                    await updateDoc(doc(db, 'transactions', transactionId), { status: newStatus });
                } catch (error) {
                    console.error(`Error ${newStatus.toLowerCase()}ing expense:`, error);
                    alert(`Failed to ${newStatus.toLowerCase()} expense.`);
                }
            }
        });

        payrollForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const staffName = payrollStaffSelect.value;
            const amount = parseFloat(payrollAmountInput.value);
            const loggedInUser = allUsers.find(u => u.uid === auth.currentUser.uid)?.name || 'Admin';

            if (!staffName || !amount) {
                alert("Please select a staff member and enter an amount.");
                return;
            }

            try {
                await addDoc(collection(db, 'transactions'), {
                    type: 'Expense',
                    description: `Payroll for ${staffName}`,
                    amount: amount,
                    client: 'Internal Firm',
                    loggedBy: loggedInUser,
                    status: 'Approved', // Payroll is pre-approved
                    createdAt: new Date().toISOString()
                });
                payrollForm.reset();
                alert(`Payroll for ${staffName} logged successfully!`);
            } catch (error) {
                console.error("Error logging payroll:", error);
                alert("Failed to log payroll.");
            }
        });


        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists() && ['Managing Partner', 'Senior Partner'].includes(userDocSnap.data().role)) {
                        // User is admin, show content
                        authBlocker.classList.add('hidden');
                        adminPortalContent.classList.remove('hidden');

                        // Load staff first, then other data
                        const usersCollection = collection(db, 'users');
                        onSnapshot(usersCollection, (snapshot) => {
                            allUsers = snapshot.docs.map(d => ({ uid: d.id, ...d.data() }));
                            renderStaffTable();
                            listenForAnalytics();
                            listenForExpenseApprovals();
                        });

                    } else {
                        // User is not admin, keep blocker
                        loadingSpinner.classList.add('hidden');
                        redirectLink.classList.remove('hidden');
                        authBlocker.classList.remove('hidden');
                        adminPortalContent.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error checking admin role:", error);
                    loadingSpinner.classList.add('hidden');
                    redirectLink.classList.remove('hidden');
                }
            } else {
                // Not logged in
                loadingSpinner.classList.add('hidden');
                redirectLink.classList.remove('hidden');
            }
        });

        // --- Admin SPA Navigation ---
        const adminNavLinks = document.querySelectorAll('.admin-nav-link');
        const adminPageContents = document.querySelectorAll('.admin-page-content');

        adminNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);

                adminPageContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');

                adminNavLinks.forEach(nav => {
                    nav.classList.remove('bg-gray-700', 'text-white');
                    nav.classList.add('text-gray-400');
                });
                link.classList.add('bg-gray-700', 'text-white');
                link.classList.remove('text-gray-400');
            });
        });

    </script>
</body>
</html>

